<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ–¼ï¸ Image Compressor with Bulk Download</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    html, body {
      height: 100%;
      min-height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #312e81 0%, #6d28d9 100%);
      color: #fff;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      padding: 0;
      box-sizing: border-box;
    }
    .main-wrapper {
      flex: 1 0 auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 0;
      min-width: 0;
    }
    .max-w-5xl {
      width: 100%;
      max-width: 48rem;
    }
    .bg-gray-800 {
      background-color: #1f2937;
    }
    .p-6 {
      padding: 1.5rem;
    }
    .rounded-2xl {
      border-radius: 1rem;
    }
    .shadow-2xl {
      box-shadow: 0 10px 40px 0 #00000040;
    }
    img { max-height: 200px; border-radius: 10px; }
    .drop-zone { border: 4px dashed #7c3aed; padding: 40px; border-radius: 18px; cursor: pointer; text-align: center; font-size: 1.1rem; color: #d1d5db; background: linear-gradient(to right, #2e1065, #4c1d95); transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s; animation: subtlePulse 3s infinite; }
    .drop-zone:hover { transform: scale(1.02); box-shadow: 0 0 20px #a78bfa; }
    .drop-zone.dragover { background-color: #4c1d95; border-color: #c084fc; animation: none; }
    @keyframes subtlePulse { 0%, 100% { box-shadow: 0 0 10px #7c3aed; } 50% { box-shadow: 0 0 30px #a78bfa; } }
    .file-btn { background-color: #9333ea; color: white; padding: 0.5rem 1rem; border-radius: 10px; cursor: pointer; }
    .file-btn:hover { background-color: #a855f7; }
    input[type="file"] { display: none; }
    .fancy-btn { background: linear-gradient(90deg, #7c3aed, #a855f7); box-shadow: 0 0 20px #9333ea; transition: all 0.3s; }
    .fancy-btn:hover { background: linear-gradient(90deg, #a855f7, #9333ea); box-shadow: 0 0 30px #c084fc; transform: scale(1.05); }
    .preview-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; }
    .preview-label { text-align: center; font-size: 0.9rem; color: #a78bfa; margin-bottom: 0.5rem; }
    .filter-btn { background: #4c1d95; color: white; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 1px solid #7c3aed; }
    .filter-btn:hover { background: #7c3aed; transform: translateY(-2px); }
    .filter-btn.active { background: #7c3aed; box-shadow: 0 0 10px #a78bfa; }
    .filter-container { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; margin: 1rem 0; }
    .filter-instruction { text-align: center; font-size: 0.9rem; color: #a78bfa; margin-bottom: 0.5rem; }
    .filter-slider-container { display: flex; align-items: center; gap: 1rem; justify-content: center; margin-bottom: 1rem; }
    .filter-slider-label { color: #a78bfa; font-size: 0.95rem; min-width: 90px; text-align: right; }
    .filter-slider-value { color: #c084fc; font-weight: bold; min-width: 40px; text-align: left; }
    .bulk-list { color: #a78bfa; font-size: 0.95rem; margin-bottom: 0.5rem; }
    /* Responsive adjustments */
    @media (max-width: 900px) {
      .max-w-5xl { max-width: 100%; }
      .preview-container { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      .main-wrapper { padding: 0.5rem; }
      .p-6 { padding: 1rem; }
      .preview-container { grid-template-columns: 1fr; }
      .drop-zone { padding: 20px; font-size: 1rem; }
    }
    /* Remove extra space below the black box */
    .signature-container {
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      text-align: right;
      width: 100%;
    }
    @media (max-width: 640px) {
      .signature-container {
        text-align: center;
        margin-top: 1rem;
      }
    }
    /* Prevent extra space below main content */
    .main-wrapper > .max-w-5xl {
      margin-bottom: 0;
    }
  </style>
</head>
<body>
    
<div class="main-wrapper">
  <div class="max-w-5xl bg-gray-800 p-6 rounded-2xl shadow-2xl">
  <div class="w-full flex justify-start mb-4">
    <button 
      onclick="location.reload()" 
      class="bg-gray-700 hover:bg-purple-600 text-white px-4 py-2 rounded-xl font-semibold shadow transition"
      style="margin-top: 1rem; margin-left: 1rem;"
    >ğŸ  Home</button>
  </div>
    <h1 class="text-3xl font-bold text-center mb-6 animate-pulse">ğŸ¨ Image Compressor with Bulk Download</h1>

    <div class="flex justify-center gap-4 mb-6">
      <button id="easyTab" class="bg-purple-600 px-5 py-2 rounded-xl font-semibold shadow">ğŸŸ¢ Easy Mode</button>
      <button id="advancedTab" class="bg-gray-700 px-5 py-2 rounded-xl font-semibold shadow">âš™ï¸ Advanced Mode</button>
    </div>

    <div id="dropZone" class="drop-zone mb-6">
      ğŸ“‚ Drag & Drop Image(s) Here or <label for="fileInput" class="file-btn">ğŸ“ Choose File(s)</label>
      <input type="file" id="fileInput" accept="image/*" multiple>
    </div>
    <div class="flex justify-center mb-4">
    <button 
        id="addMoreBtn"
        class="bg-gray-700 hover:bg-purple-600 text-white px-4 py-2 rounded-xl font-semibold shadow transition"
        type="button"
    >â• Add More Files</button>
    </div>

    <p id="fileNameDisplay" class="text-center text-sm text-purple-300 mb-4 hidden">ğŸ“„ Selected File: <span id="fileName"></span></p>
    <div id="bulkList" class="bulk-list"></div>

    <!-- Easy Mode -->
    <div id="easyMode" class="block text-center space-y-4">
      <label>ğŸšï¸ Quality: <span id="easyQualityVal">70%</span></label>
      <input type="range" id="easyQuality" min="1" max="100" step="1" value="40" class="w-full max-w-xs mx-auto">
      <p class="filter-instruction">Click the buttons below to preview and apply filters to your image.</p>
      <div class="filter-container">
        <button class="filter-btn" data-filter="none">None</button>
        <button class="filter-btn" data-filter="grayscale">Grayscale</button>
        <button class="filter-btn" data-filter="sepia">Sepia</button>
        <button class="filter-btn" data-filter="invert">Invert</button>
        <button class="filter-btn" data-filter="blur">Blur</button>
        <button class="filter-btn" data-filter="vintage">Vintage</button>
      </div>
      <div class="preview-container">
        <div>
          <div class="preview-label">ğŸ–¼ï¸ Original</div>
          <div id="easyOriginalPreview"></div>
        </div>
        <div>
          <div class="preview-label">ğŸ§  Compressed</div>
          <div id="easyCompressedPreview"></div>
        </div>
      </div>
      <div id="easyEstimate" class="text-sm text-gray-300 hidden"></div>
      <div id="easyAiMessage" class="text-sm font-semibold text-purple-400 hidden"></div>
      <button id="easyDownload" class="hidden fancy-btn px-6 py-3 rounded-xl font-semibold">â¬‡ï¸ Download</button>
    </div>

    <!-- Advanced Mode -->
    <div id="advancedMode" class="hidden space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div>
          <label>ğŸ“ Width (px)</label>
          <input type="number" id="imgWidth" class="w-full p-2 rounded-lg bg-gray-700 text-white">
        </div>
        <div>
          <label>ğŸ“ Height (px)</label>
          <input type="number" id="imgHeight" class="w-full p-2 rounded-lg bg-gray-700 text-white">
        </div>
        <div>
          <label>ğŸšï¸ Quality: <span id="qualityValue">70%</span></label>
          <input type="range" id="qualityRange" min="1" max="100" step="1" value="40" class="w-full">
        </div>
      </div>
      <div>
        <label>ğŸ“ Format:</label>
        <select id="formatSelect" class="w-full p-2 rounded-lg bg-gray-700 text-white">
          <option value="image/jpeg">JPEG (.jpg)</option>
          <option value="image/png">PNG (.png)</option>
          <option value="image/webp">WebP (.webp)</option>
          <option value="image/bmp">BMP (.bmp)</option>
          <option value="image/avif">AVIF (.avif)</option>
        </select>
      </div>
      <div>
        <label>ğŸ’¾ Max File Size (KB):</label>
        <input type="number" id="maxSizeKB" placeholder="e.g. 200" class="w-full p-2 rounded-lg bg-gray-700 text-white">
      </div>
      <div class="flex justify-center gap-4 my-2">
        <button id="toggleFilters" class="bg-purple-600 px-4 py-2 rounded-xl font-semibold shadow">Filters</button>
        <button id="toggleManual" class="bg-gray-700 px-4 py-2 rounded-xl font-semibold shadow">Manual Edit</button>
      </div>
      <div id="filtersPanel">
        <p class="filter-instruction">Click the buttons below to preview and apply filters to your image.</p>
        <div class="filter-container" id="advancedFilterContainer">
          <button class="filter-btn" data-filter="none">None</button>
          <button class="filter-btn" data-filter="grayscale">Grayscale</button>
          <button class="filter-btn" data-filter="sepia">Sepia</button>
          <button class="filter-btn" data-filter="invert">Invert</button>
          <button class="filter-btn" data-filter="blur">Blur</button>
          <button class="filter-btn" data-filter="vintage">Vintage</button>
        </div>
        <div class="filter-slider-container" id="filterSliderContainer" style="display:none;">
          <span class="filter-slider-label" id="filterSliderLabel"></span>
          <input type="range" id="filterSlider" min="0" max="100" value="50" class="w-64">
          <span class="filter-slider-value" id="filterSliderValue"></span>
        </div>
      </div>
      <div id="manualPanel" style="display:none;">
        <p class="filter-instruction">Adjust the sliders below for manual editing.</p>
        <div class="space-y-2 max-w-md mx-auto">
          <label>Brightness: <span id="brightnessVal">100</span>%</label>
          <input type="range" id="brightnessSlider" min="0" max="200" value="100" class="w-full">
          <label>Contrast: <span id="contrastVal">100</span>%</label>
          <input type="range" id="contrastSlider" min="0" max="200" value="100" class="w-full">
          <label>Grayscale: <span id="grayscaleVal">0</span>%</label>
          <input type="range" id="grayscaleSlider" min="0" max="100" value="0" class="w-full">
        </div>
      </div>
      <div id="estimate" class="text-sm text-gray-300 hidden"></div>
      <div id="aiMessage" class="text-sm font-semibold text-purple-400 hidden"></div>
      <div class="preview-container">
        <div>
          <div class="preview-label">ğŸ–¼ï¸ Original</div>
          <div id="originalPreview"></div>
        </div>
        <div>
          <div class="preview-label">ğŸ§  Compressed</div>
          <div id="compressedPreview"></div>
        </div>
      </div>
      <button id="downloadBtn" class="hidden fancy-btn px-6 py-3 rounded-xl font-semibold">â¬‡ï¸ Download</button>
    </div>
    <canvas id="canvas" class="hidden"></canvas>
  </div>
</div>
<script>
const addMoreBtn = document.getElementById("addMoreBtn");
const easyTab = document.getElementById("easyTab");
const advancedTab = document.getElementById("advancedTab");
const easyMode = document.getElementById("easyMode");
const advancedMode = document.getElementById("advancedMode");
const fileNameDisplay = document.getElementById("fileNameDisplay");
const fileNameText = document.getElementById("fileName");
const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const widthInput = document.getElementById("imgWidth");
const heightInput = document.getElementById("imgHeight");
const qualityRange = document.getElementById("qualityRange");
const qualityValue = document.getElementById("qualityValue");
const formatSelect = document.getElementById("formatSelect");
const maxSizeInput = document.getElementById("maxSizeKB");
const originalPreview = document.getElementById("originalPreview");
const compressedPreview = document.getElementById("compressedPreview");
const estimate = document.getElementById("estimate");
const aiMessage = document.getElementById("aiMessage");
const downloadBtn = document.getElementById("downloadBtn");
const easyOriginalPreview = document.getElementById("easyOriginalPreview");
const easyCompressedPreview = document.getElementById("easyCompressedPreview");
const easyEstimate = document.getElementById("easyEstimate");
const easyAiMessage = document.getElementById("easyAiMessage");
const easyDownload = document.getElementById("easyDownload");
const easyQuality = document.getElementById("easyQuality");
const easyQualityVal = document.getElementById("easyQualityVal");
const filterSliderContainer = document.getElementById("filterSliderContainer");
const filterSlider = document.getElementById("filterSlider");
const filterSliderLabel = document.getElementById("filterSliderLabel");
const filterSliderValue = document.getElementById("filterSliderValue");
const toggleFilters = document.getElementById("toggleFilters");
const toggleManual = document.getElementById("toggleManual");
const filtersPanel = document.getElementById("filtersPanel");
const manualPanel = document.getElementById("manualPanel");
const brightnessSlider = document.getElementById("brightnessSlider");
const contrastSlider = document.getElementById("contrastSlider");
const grayscaleSlider = document.getElementById("grayscaleSlider");
const brightnessVal = document.getElementById("brightnessVal");
const contrastVal = document.getElementById("contrastVal");
const grayscaleVal = document.getElementById("grayscaleVal");
const bulkList = document.getElementById("bulkList");

let originalFile, originalImage;
let isProcessing = false;
let currentFilter = 'none';
let filterButtons;
let advancedFilterButtons;
let currentFilterStrength = 50;
let manualMode = false;
let manualSettings = { brightness: 100, contrast: 100, grayscale: 0 };
let bulkFiles = [];
let activeFileIndex = 0;

const filterSliderConfigs = {
  grayscale: { label: "Grayscale", min: 0, max: 100, value: 100, unit: "%" },
  sepia:    { label: "Sepia", min: 0, max: 100, value: 100, unit: "%" },
  invert:   { label: "Invert", min: 0, max: 100, value: 100, unit: "%" },
  blur:     { label: "Blur", min: 0, max: 20, value: 5, unit: "px" },
  vintage:  { label: "Vintage", min: 0, max: 100, value: 50, unit: "%" }
};

addMoreBtn.onclick = () => {
  fileInput.value = ""; // allow re-selecting same files
  fileInput.click();
};

easyTab.onclick = () => {
  easyMode.classList.remove("hidden");
  advancedMode.classList.add("hidden");
  easyTab.classList.replace("bg-gray-7", "bg-purple-600");
  advancedTab.classList.replace("bg-purple-600", "bg-gray-700");
  updateDownloadButtons();
};
advancedTab.onclick = () => {
  advancedMode.classList.remove("hidden");
  easyMode.classList.add("hidden");
  advancedTab.classList.replace("bg-gray-700", "bg-purple-600");
  easyTab.classList.replace("bg-purple-600", "bg-gray-700");
  updateDownloadButtons();
};

dropZone.addEventListener("dragover", e => {
  e.preventDefault(); 
  dropZone.classList.add("dragover");
});
dropZone.addEventListener("dragleave", () => {
  dropZone.classList.remove("dragover");
});
dropZone.addEventListener("drop", e => {
  e.preventDefault(); 
  dropZone.classList.remove("dragover");
  handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener("change", () => handleFiles(fileInput.files));

function handleFiles(files) {
  bulkFiles = Array.from(files);
  if (bulkFiles.length === 0) return;
  if (bulkFiles.length === 1) {
    handleFile(bulkFiles[0]);
    bulkList.innerHTML = "";
  } else {
    bulkList.innerHTML = "Bulk files: " + bulkFiles.map(f => f.name).join(", ");
    activeFileIndex = 0;
    handleFile(bulkFiles[0]);
  }
  setTimeout(updateDownloadButtons, 300);
}

function handleFiles(files) {
  const newFiles = Array.from(files);
  // Only add files that are not already in bulkFiles (by name)
  newFiles.forEach(f => {
    if (!bulkFiles.some(existing => existing.name === f.name && existing.size === f.size)) {
      bulkFiles.push(f);
    }
  });
  if (bulkFiles.length === 0) return;
  if (bulkFiles.length === 1) {
    handleFile(bulkFiles[0]);
    bulkList.innerHTML = "";
  } else {
    activeFileIndex = 0;
    handleFile(bulkFiles[bulkFiles.length - 1]);
    renderBulkList();
  }
  setTimeout(updateDownloadButtons, 300);
}

function handleFile(file) {
  if (!file) return;
  originalFile = file;
  fileNameDisplay.classList.remove("hidden");
  fileNameText.textContent = file.name;
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      originalImage = img;
      widthInput.value = img.width;
      heightInput.value = img.height;
      originalPreview.innerHTML = `<img src="${e.target.result}">`;
      easyOriginalPreview.innerHTML = `<img src="${e.target.result}">`;
      compressNow();
      compressEasy();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

document.addEventListener('DOMContentLoaded', () => {
  filterButtons = document.querySelectorAll('.filter-container:not(#advancedFilterContainer) .filter-btn');
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      if (originalImage) compressEasy();
    });
  });
  advancedFilterButtons = document.querySelectorAll('#advancedFilterContainer .filter-btn');
  advancedFilterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      advancedFilterButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      if (currentFilter !== 'none') {
        const cfg = filterSliderConfigs[currentFilter] || {label: "Strength", min: 0, max: 100, value: 50, unit: ""};
        filterSliderContainer.style.display = "";
        filterSliderLabel.textContent = cfg.label;
        filterSlider.min = cfg.min;
        filterSlider.max = cfg.max;
        filterSlider.value = cfg.value;
        filterSliderValue.textContent = cfg.value + cfg.unit;
        currentFilterStrength = cfg.value;
      } else {
        filterSliderContainer.style.display = "none";
      }
      if (originalImage && !manualMode) compressNow();
    });
  });
  filterSlider.addEventListener('input', () => {
    currentFilterStrength = filterSlider.value;
    const cfg = filterSliderConfigs[currentFilter] || {unit:""};
    filterSliderValue.textContent = filterSlider.value + cfg.unit;
    if (originalImage && !manualMode) compressNow();
  });
  [brightnessSlider, contrastSlider, grayscaleSlider].forEach(slider => {
    slider.addEventListener("input", () => {
      manualSettings.brightness = parseInt(brightnessSlider.value);
      manualSettings.contrast = parseInt(contrastSlider.value);
      manualSettings.grayscale = parseInt(grayscaleSlider.value);
      brightnessVal.textContent = manualSettings.brightness;
      contrastVal.textContent = manualSettings.contrast;
      grayscaleVal.textContent = manualSettings.grayscale;
      if (originalImage && manualMode) compressNow();
    });
  });
  toggleFilters.onclick = () => {
    manualMode = false;
    filtersPanel.style.display = "";
    manualPanel.style.display = "none";
    toggleFilters.classList.replace("bg-gray-700", "bg-purple-600");
    toggleManual.classList.replace("bg-purple-600", "bg-gray-700");
    if (originalImage) compressNow();
  };
  toggleManual.onclick = () => {
    manualMode = true;
    filtersPanel.style.display = "none";
    manualPanel.style.display = "";
    toggleManual.classList.replace("bg-gray-700", "bg-purple-600");
    toggleFilters.classList.replace("bg-purple-600", "bg-gray-700");
    if (originalImage) compressNow();
  };
});

// Set default quality display to 40%
easyQualityVal.textContent = "40%";
qualityValue.textContent = "40%";

function applyFilter(imageData, filter, strength) {
  if (!filter || filter === "none") return imageData;
  const data = imageData.data;
  switch(filter) {
    case 'grayscale': {
      const s = (typeof strength === "undefined") ? 100 : parseInt(strength,10);
      for (let i = 0; i < data.length; i += 4) {
        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
        data[i] = data[i] + (avg - data[i]) * (s/100);
        data[i+1] = data[i+1] + (avg - data[i+1]) * (s/100);
        data[i+2] = data[i+2] + (avg - data[i+2]) * (s/100);
      }
      break;
    }
    case 'sepia': {
      const s = (typeof strength === "undefined") ? 100 : parseInt(strength,10);
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i], g = data[i+1], b = data[i+2];
        const tr = Math.min(255, (r * 0.393) + (g * 0.769) + (b * 0.189));
        const tg = Math.min(255, (r * 0.349) + (g * 0.686) + (b * 0.168));
        const tb = Math.min(255, (r * 0.272) + (g * 0.534) + (b * 0.131));
        data[i]   = r + (tr - r) * (s/100);
        data[i+1] = g + (tg - g) * (s/100);
        data[i+2] = b + (tb - b) * (s/100);
      }
      break;
    }
    case 'invert': {
      const s = (typeof strength === "undefined") ? 100 : parseInt(strength,10);
      for (let i = 0; i < data.length; i += 4) {
        data[i]   = data[i]   + ((255 - data[i])   - data[i])   * (s/100);
        data[i+1] = data[i+1] + ((255 - data[i+1]) - data[i+1]) * (s/100);
        data[i+2] = data[i+2] + ((255 - data[i+2]) - data[i+2]) * (s/100);
      }
      break;
    }
    case 'blur': {
      const blurAmount = (typeof strength === "undefined") ? 5 : parseInt(strength,10);
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      tempCanvas.width = imageData.width;
      tempCanvas.height = imageData.height;
      tempCtx.putImageData(imageData, 0, 0);
      tempCtx.filter = `blur(${blurAmount}px)`;
      tempCtx.drawImage(tempCanvas, 0, 0);
      return tempCtx.getImageData(0, 0, imageData.width, imageData.height);
    }
    case 'vintage': {
      const s = (typeof strength === "undefined") ? 50 : parseInt(strength,10);
      for (let i = 0; i < data.length; i += 4) {
        data[i]   = data[i]   * (1 - 0.1 * (s/100));
        data[i+1] = data[i+1] * (1 - 0.2 * (s/100));
        data[i+2] = data[i+2] * (1 - 0.5 * (s/100));
        data[i+3] = data[i+3] * (1 - 0.1 * (s/100));
      }
      break;
    }
    default:
      break;
  }
  return imageData;
}
function applyManualControls(imageData, settings) {
  const data = imageData.data;
  const b = settings.brightness / 100;
  const c = (259 * (settings.contrast + 255)) / (255 * (259 - settings.contrast));
  const g = settings.grayscale / 100;
  for (let i = 0; i < data.length; i += 4) {
    data[i] = Math.min(255, data[i] * b);
    data[i+1] = Math.min(255, data[i+1] * b);
    data[i+2] = Math.min(255, data[i+2] * b);
    data[i] = Math.min(255, Math.max(0, c * (data[i] - 128) + 128));
    data[i+1] = Math.min(255, Math.max(0, c * (data[i+1] - 128) + 128));
    data[i+2] = Math.min(255, Math.max(0, c * (data[i+2] - 128) + 128));
    if (g > 0) {
      const avg = (data[i] + data[i+1] + data[i+2]) / 3;
      data[i] = data[i] + (avg - data[i]) * g;
      data[i+1] = data[i+1] + (avg - data[i+1]) * g;
      data[i+2] = data[i+2] + (avg - data[i+2]) * g;
    }
  }
  return imageData;
}

[easyQuality, qualityRange, widthInput, heightInput, formatSelect, maxSizeInput].forEach(el => {
  el.addEventListener("input", () => {
    if (isProcessing) return;
    easyQualityVal.textContent = easyQuality.value + "%";
    qualityValue.textContent = qualityRange.value + "%";
    if (originalImage) {
      if (el === easyQuality) compressEasy();
      else compressNow();
    }
  });
});

function compressEasy() {
  if (!originalImage) return;
  isProcessing = true;
  canvas.width = originalImage.width;
  canvas.height = originalImage.height;
  ctx.drawImage(originalImage, 0, 0);
  if (currentFilter !== 'none') {
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const filteredData = applyFilter(imageData, currentFilter, 100);
    ctx.putImageData(filteredData, 0, 0);
  }
  const quality = parseInt(easyQuality.value) / 100;
  canvas.toBlob(blob => {
    const url = URL.createObjectURL(blob);
    easyCompressedPreview.innerHTML = `<img src="${url}" />`;
    const originalKB = (originalFile.size / 1024).toFixed(2);
    const compressedKB = (blob.size / 1024).toFixed(2);
    const ratio = ((blob.size / originalFile.size) * 100).toFixed(1);
    easyEstimate.classList.remove("hidden");
    easyAiMessage.classList.remove("hidden");
    easyEstimate.innerHTML = `ğŸ“¦ Original: <b>${originalKB} KB</b><br>ğŸ“‰ Compressed: <b>${compressedKB} KB</b><br>ğŸ“Š Ratio: ${ratio}%`;
    easyAiMessage.textContent =
      quality < 0.3 ? "ğŸ˜¬ Too blurry!" :
      quality < 0.7 ? "ğŸ‘Œ Balanced!" :
      "ğŸ–¼ï¸ High Quality!";
    easyDownload.classList.remove("hidden");
    updateDownloadButtons();
    isProcessing = false;
  }, "image/jpeg", quality);
}

function compressNow() {
  if (!originalImage) return;
  isProcessing = true;
  const width = parseInt(widthInput.value) || originalImage.width;
  const height = parseInt(heightInput.value) || originalImage.height;
  const quality = parseInt(qualityRange.value) / 100;
  const format = formatSelect.value;
  const maxSizeKB = parseInt(maxSizeInput.value);
  canvas.width = width;
  canvas.height = height;
  ctx.drawImage(originalImage, 0, 0, width, height);
  if (manualMode) {
    let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    imageData = applyManualControls(imageData, manualSettings);
    ctx.putImageData(imageData, 0, 0);
  } else if (currentFilter !== 'none') {
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const filteredData = applyFilter(imageData, currentFilter, currentFilterStrength);
    ctx.putImageData(filteredData, 0, 0);
  }
  canvas.toBlob(blob => {
    let finalBlob = blob;
    let finalSizeKB = blob.size / 1024;
    let adjustedQuality = quality;
    let finalUrl = URL.createObjectURL(finalBlob);
    let attempts = 0;
    const maxAttempts = 5;
    if (maxSizeKB && finalSizeKB > maxSizeKB && attempts < maxAttempts) {
      let newQuality = quality;
      while (finalSizeKB > maxSizeKB && attempts < maxAttempts) {
        newQuality = Math.max(0.1, newQuality - 0.1);
        canvas.toBlob(newBlob => {
          if (!newBlob) return;
          finalBlob = newBlob;
          finalSizeKB = newBlob.size / 1024;
          finalUrl = URL.createObjectURL(newBlob);
        }, format, newQuality);
        attempts++;
      }
    }
    compressedPreview.innerHTML = `<img src="${finalUrl}" />`;
    const originalKB = (originalFile.size / 1024).toFixed(2);
    const compressedKB = (finalBlob.size / 1024).toFixed(2);
    const ratio = ((finalBlob.size / originalFile.size) * 100).toFixed(1);
    estimate.classList.remove("hidden");
    aiMessage.classList.remove("hidden");
    estimate.innerHTML = `ğŸ“¦ Original: <b>${originalKB} KB</b><br>ğŸ“‰ Compressed: <b>${compressedKB} KB</b><br>ğŸ“Š Ratio: ${ratio}%`;
    aiMessage.textContent =
      adjustedQuality < 0.3 ? "ğŸ˜¬ Too blurry!" :
      adjustedQuality < 0.7 ? "ğŸ‘Œ Balanced!" :
      "ğŸ–¼ï¸ High Quality!";
    downloadBtn.classList.remove("hidden");
    updateDownloadButtons();
    isProcessing = false;
  }, format, quality);
}

// --- BULK DOWNLOAD LOGIC ---
function updateDownloadButtons() {
  // Easy Mode
  if (bulkFiles.length > 1) {
    easyDownload.textContent = "â¬‡ï¸ Bulk Download";
    easyDownload.onclick = () => bulkDownload('easy');
  } else {
    easyDownload.textContent = "â¬‡ï¸ Download";
    easyDownload.onclick = () => {
      const img = easyCompressedPreview.querySelector('img');
      if (!img) return;
      const link = document.createElement("a");
      link.href = img.src;
      link.download = `easy-compressed-${currentFilter}.jpg`;
      link.click();
    };
  }
  // Advanced Mode
  if (bulkFiles.length > 1) {
    downloadBtn.textContent = "â¬‡ï¸ Bulk Download";
    downloadBtn.onclick = () => bulkDownload('advanced');
  } else {
    downloadBtn.textContent = "â¬‡ï¸ Download";
    downloadBtn.onclick = () => {
      const img = compressedPreview.querySelector('img');
      if (!img) return;
      const link = document.createElement("a");
      link.href = img.src;
      link.download = `compressed-${currentFilter}.${(formatSelect.value||'image/jpeg').split('/')[1].replace('jpeg','jpg')}`;
      link.click();
    };
  }
}

function bulkDownload(mode) {
  if (bulkFiles.length < 2) return;
  const zip = new JSZip();
  function processFile(i) {
    if (i >= bulkFiles.length) {
      zip.generateAsync({type:"blob"}).then(function(content) {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "compressed-images.zip";
        a.click();
      });
      return;
    }
    const file = bulkFiles[i];
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        let w = img.width, h = img.height, q = 0.7, format = "image/jpeg";
        if (mode === 'advanced') {
          w = parseInt(widthInput.value) || img.width;
          h = parseInt(heightInput.value) || img.height;
          q = parseInt(qualityRange.value) / 100;
          format = formatSelect.value;
        } else {
          q = parseInt(easyQuality.value) / 100;
        }
        canvas.width = w; canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        if (mode === 'advanced') {
          if (manualMode) {
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            imageData = applyManualControls(imageData, manualSettings);
            ctx.putImageData(imageData, 0, 0);
          } else if (currentFilter !== 'none') {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const filteredData = applyFilter(imageData, currentFilter, currentFilterStrength);
            ctx.putImageData(filteredData, 0, 0);
          }
        } else {
          if (currentFilter !== 'none') {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const filteredData = applyFilter(imageData, currentFilter, 100);
            ctx.putImageData(filteredData, 0, 0);
          }
        }
        canvas.toBlob(blob => {
          zip.file(file.name.replace(/\.[^.]+$/, ".jpg"), blob);
          processFile(i+1);
        }, "image/jpeg", q);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
  processFile(0);
}

function renderBulkList() {
  if (bulkFiles.length <= 1) {
    bulkList.innerHTML = "";
    return;
  }
  bulkList.innerHTML = bulkFiles.map((f, idx) => {
    const url = URL.createObjectURL(f);
    return `<span style="display:inline-block;position:relative;margin:0 8px 8px 0;">
      <img src="${url}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;border:2px solid #a78bfa;box-shadow:0 2px 8px #0002;vertical-align:middle;">
      <button onclick="deleteBulkFile(${idx})" style="position:absolute;top:-8px;right:-8px;background:#f472b6;border:none;border-radius:50%;width:22px;height:22px;color:#fff;font-weight:bold;cursor:pointer;box-shadow:0 1px 4px #0003;">âœ–</button>
      <div style='font-size:11px;color:#a78bfa;text-align:center;max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;'>${f.name}</div>
    </span>`;
  }).join("");
}

function deleteBulkFile(idx) {
  // Remove file and update previews
  const wasCurrent = (bulkFiles[idx] === originalFile);
  bulkFiles.splice(idx, 1);
  if (bulkFiles.length === 0) {
    originalFile = null;
    originalImage = null;
    fileNameDisplay.classList.add("hidden");
    originalPreview.innerHTML = "";
    compressedPreview.innerHTML = "";
    easyOriginalPreview.innerHTML = "";
    easyCompressedPreview.innerHTML = "";
    easyEstimate.classList.add("hidden");
    easyAiMessage.classList.add("hidden");
    estimate.classList.add("hidden");
    aiMessage.classList.add("hidden");
    easyDownload.classList.add("hidden");
    downloadBtn.classList.add("hidden");
  } else {
    // If deleted file was current, show next or previous
    let nextIdx = idx;
    if (nextIdx >= bulkFiles.length) nextIdx = bulkFiles.length - 1;
    handleFile(bulkFiles[nextIdx]);
  }
  renderBulkList();
  updateDownloadButtons();
}

// Patch handleFiles to call renderBulkList
function handleFiles(files) {
  const newFiles = Array.from(files);
  newFiles.forEach(f => {
    if (!bulkFiles.some(existing => existing.name === f.name && existing.size === f.size)) {
      bulkFiles.push(f);
    }
  });
  if (bulkFiles.length === 0) return;
  if (bulkFiles.length === 1) {
    handleFile(bulkFiles[0]);
    bulkList.innerHTML = "";
  } else {
    activeFileIndex = 0;
    handleFile(bulkFiles[bulkFiles.length - 1]);
    renderBulkList();
  }
  setTimeout(updateDownloadButtons, 300);
}
</script>
<!-- Add this just before </body> -->
<div class="signature-container">
  <span class="signature-text">&mdash; made with <span class="signature-heart">â¤</span> by <span class="signature-highlight">shibbux</span></span>
</div>
<link href="https://fonts.googleapis.com/css?family=Pacifico|Dancing+Script&display=swap" rel="stylesheet">
<style>
  .signature-text {
    font-family: 'Pacifico', 'Dancing Script', cursive, sans-serif;
    font-size: 2rem;
    color: #fff;
    background: none;
    -webkit-background-clip: initial;
    background-clip: initial;
    -webkit-text-fill-color: initial;
    text-shadow: 2px 2px 8px #00000033;
    letter-spacing: 2px;
    user-select: none;
    display: inline-block;
    padding-right: 0.5rem;
  }
  .signature-highlight {
    color: #fff;
    background: none;
    -webkit-text-fill-color: #fff;
  }
  .signature-heart {
    color: #ff4d6d;
    font-size: 1.2em;
    vertical-align: middle;
    margin: 0 0.2em;
  }
  @media (max-width: 640px) {
    .signature-text {
      font-size: 1.2rem;
      padding-right: 0.2rem;
    }
  }
</style>
<!-- End signature -->
</body>
</html>
